<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RJ Cars - Your Trusted Car Dealer</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Keep only one jQuery script for brand/model interaction -->
    <script>
        $(document).ready(function() {
            // When brand changes, load models
            $('#brand').change(function() {
                var brand = $(this).val();
                if (brand) {
                    $.ajax({
                        url: '/get_models/' + brand,
                        type: 'GET',
                        success: function(data) {
                            var modelSelect = $('#model');
                            // Store currently selected model (if any)
                            var currentModel = modelSelect.val();
                            
                            modelSelect.empty();
                            modelSelect.append('<option value="">Select Model</option>');
                            
                            $.each(data.models, function(i, item) {
                                modelSelect.append('<option value="' + item + '">' + item + '</option>');
                            });
                            
                            // If we had a model selected and it's in the new options, restore it
                            if (currentModel && modelSelect.find('option[value="' + currentModel + '"]').length) {
                                modelSelect.val(currentModel);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error loading models:', error);
                            // Provide visible feedback about the error
                            alert('Could not load models for this brand. Please try again.');
                        }
                    });
                } else {
                    $('#model').empty().append('<option value="">Select Model</option>');
                }
            });
    
            // Initialize form with any previously selected values
            {% if form.brand.data %}
                $('#brand').trigger('change');
                setTimeout(function() {
                    $('#model').val("{{ form.model.data }}");
                    console.log("Setting model to:", "{{ form.model.data }}");
                }, 1000); // Increased timeout to ensure AJAX completes
            {% endif %}
            
            // Add log before form submission to check model value
            $('form').submit(function() {
                console.log("Submitting form with model value:", $('#model').val());
            });
        });
    </script>
</head>
<body>
    <div class="header">
        <h1>Welcome to RJ Cars</h1>
        <p>Find Your Dream Car Today</p>
    </div>

    <div class="nav">
        <a href="{{ url_for('homepage') }}">Home</a>
        <a href="{{ url_for('featuredCars') }}">Featured Cars</a>
        <a href="{{ url_for('search') }}">Search vehicles</a>
        <a href="{{ url_for('sellers') }}">Sellers</a>
    </div>

    <div class="search-form">
        <form method="POST" action="{{ url_for('search') }}">
            {{ form.hidden_tag() }}
            <div>
                {{ form.brand.label }}<br>
                {{ form.brand() }}
                {% for error in form.brand.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
    
            <div>
                {{ form.model.label }}<br>
                {{ form.model() }}
                {% for error in form.model.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
    
            <div>
                {{ form.year.label }}<br>
                {{ form.year(placeholder="Enter Year") }}
                {% for error in form.year.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
    
            <div>
                {{ form.price.label }}<br>
                {{ form.price(placeholder="Enter Price") }}
                {% for error in form.price.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
    
            <div>
                {{ form.mileage.label }}<br>
                {{ form.mileage(placeholder="Enter Mileage") }}
                {% for error in form.mileage.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
    
            <div>
                {{ form.condition.label }}<br>
                {{ form.condition() }}
                {% for error in form.condition.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
    
            <div>
                {{ form.location.label }}<br>
                {{ form.location(placeholder="Enter Location") }}
                {% for error in form.location.errors %}
                    <span style="color: red;">[{{ error }}]</span>
                {% endfor %}
            </div>
    
            <div>{{ form.submit() }}</div>
        </form>
    </div>

    <div class="footer">
        <p>&copy; 2025 RJ Cars. All rights reserved.</p>
    </div>
</body>
</html>